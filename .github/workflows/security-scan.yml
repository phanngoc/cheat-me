name: Security Scan CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily security scans at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        default: 'https://example.com'
      max_urls:
        description: 'Maximum URLs to crawl'
        required: false
        default: '50'
      depth:
        description: 'Crawl depth'
        required: false
        default: '2'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: strix_user
          POSTGRES_PASSWORD: strix_password
          POSTGRES_DB: strix_pentesting
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          uv sync
      
      - name: Install Playwright browsers
        run: |
          source .venv/bin/activate
          playwright install chromium
          playwright install-deps chromium
      
      - name: Initialize database
        run: |
          docker exec ${{ job.services.postgres.id }} psql -U strix_user -d strix_pentesting -f /docker-entrypoint-initdb.d/init.sql || true
        env:
          PGPASSWORD: strix_password
      
      - name: Make scan script executable
        run: chmod +x run_security_scan.sh
      
      - name: Run security scan
        id: scan
        run: |
          TARGET_URL="${{ github.event.inputs.target_url || 'https://httpbin.org' }}"
          MAX_URLS="${{ github.event.inputs.max_urls || '50' }}"
          DEPTH="${{ github.event.inputs.depth || '2' }}"
          
          ./run_security_scan.sh "$TARGET_URL" \
            --max-urls "$MAX_URLS" \
            --depth "$DEPTH" \
            --skip-cleanup
        continue-on-error: true
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: strix_pentesting
          DB_USER: strix_user
          DB_PASSWORD: strix_password
      
      - name: Extract scan results
        if: always()
        run: |
          LATEST_SCAN=$(ls -t scan_results/ | head -1)
          echo "SCAN_DIR=scan_results/${LATEST_SCAN}" >> $GITHUB_ENV
          
          # Extract summary statistics
          if [ -f "scan_results/${LATEST_SCAN}/security_report.txt" ]; then
            echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 50 "scan_results/${LATEST_SCAN}/security_report.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-${{ github.run_number }}
          path: ${{ env.SCAN_DIR }}
          retention-days: 30
      
      - name: Check for critical vulnerabilities
        if: always()
        run: |
          if [ -f "${{ env.SCAN_DIR }}/security_report.txt" ]; then
            CRITICAL_COUNT=$(grep -c "\[CRITICAL\]" "${{ env.SCAN_DIR }}/security_report.txt" || echo "0")
            HIGH_COUNT=$(grep -c "\[HIGH\]" "${{ env.SCAN_DIR }}/security_report.txt" || echo "0")
            
            echo "Critical vulnerabilities found: $CRITICAL_COUNT"
            echo "High vulnerabilities found: $HIGH_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::error::Found $CRITICAL_COUNT critical vulnerabilities"
              exit 1
            fi
            
            if [ "$HIGH_COUNT" -gt 5 ]; then
              echo "::warning::Found $HIGH_COUNT high-severity vulnerabilities"
            fi
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const scanDir = process.env.SCAN_DIR;
            
            let comment = '## ðŸ”’ Security Scan Results\n\n';
            
            try {
              const report = fs.readFileSync(`${scanDir}/security_report.txt`, 'utf8');
              const lines = report.split('\n').slice(0, 50);
              comment += '```\n' + lines.join('\n') + '\n```\n';
              comment += `\n[View full report in artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            } catch (error) {
              comment += 'Failed to read scan results.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify:
    needs: security-scan
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send notification
        run: |
          echo "Security scan failed or found critical vulnerabilities"
          # Add your notification logic here (Slack, email, etc.)
